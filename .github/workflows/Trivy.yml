name: SecuBot Trivy SAST

on:
  push:
    branches: [main, dev, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Repository to scan (owner/repo)'
        required: true
        default: 'WebGoat/WebGoat'

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  TRIVY_SEVERITY: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  trivy-sast-scan:
    name: Trivy SAST Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo || 'juice-shop/juice-shop' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: 'target-repo'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Trivy SAST scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: './target-repo'
          format: 'json'
          output: 'trivy_sast_report.json'
          severity: ${{ env.TRIVY_SEVERITY }}
          scanners: 'secret,misconfig'  # Solo SAST: secretos + misconfigs
          exit-code: '0'

      - name: Upload Trivy SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-sast-results
          path: trivy_sast_report.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Debug - Show report preview
        if: always()
        run: |
          echo "=== Checking report ==="
          ls -la trivy_sast_report.json || echo "Report not found"
          echo "=== First 50 lines ==="
          head -n 50 trivy_sast_report.json || echo "Cannot read file"

      - name: Send Trivy results to webhook
        if: always()
        run: |
          if [ ! -f trivy_sast_report.json ]; then
            echo "‚ùå trivy_sast_report.json not found, skipping webhook"
            exit 0
          fi

          echo "‚úÖ Report found, preparing to send..."

          # Crear payload
          PAYLOAD=$(jq -n \
            --arg source "trivy_sast" \
            --arg scan_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repository "${{ github.repository }}" \
            --arg run_id "${{ github.run_id }}" \
            --argjson trivy_data "$(cat trivy_sast_report.json)" \
            '{
              source: $source,
              scan_date: $scan_date,
              repository: $repository,
              run_id: $run_id,
              payload: $trivy_data
            }')

          echo "üì¶ Payload size: $(echo "$PAYLOAD" | wc -c) bytes"

          # Calcular firma HMAC
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | sed 's/^.* //')

          echo "üîê Signature: sha256=$SIGNATURE"

          # Enviar al webhook
          echo "üì§ Sending to webhook..."
          HTTP_CODE=$(curl -w "%{http_code}" -o response.txt \
            -X POST "https://parser-dependabot.vercel.app/webhook" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD")

          echo "üì• HTTP Status: $HTTP_CODE"
          echo "üì• Response:"
          cat response.txt

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Webhook accepted!"
          else
            echo "‚ùå Webhook rejected with status $HTTP_CODE"
          fi
        continue-on-error: true
