name: OWASP ZAP Security Scan
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Ejecutar semanalmente
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
      issues: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.10.0
      continue-on-error: true
      with:
        target: 'https://nextjs-boilerplate-mu-lilac-67.vercel.app/'
        cmd_options: '-a'
        token: ${{ secrets.GITHUB_TOKEN }}
        create_issue: false

    - name: Upload JSON Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-json-report
        path: report_json.json
        retention-days: 30

    - name: Debug - Show ZAP Report
      if: always()
      run: |
        echo "=== Checking if report exists ==="
        ls -la report_json.json || echo "report_json.json NOT FOUND"

        echo "=== First 100 lines of report ==="
        head -n 100 report_json.json || echo "Cannot read file"

        echo "=== File size ==="
        wc -c report_json.json || echo "Cannot get size"

    - name: Send ZAP results to webhook
      if: always()
      run: |
        if [ ! -f report_json.json ]; then
          echo "report_json.json not found, skipping webhook"
          exit 0
        fi

        # Crear payload completo
        PAYLOAD=$(jq -n \
          --arg source "owasp_zap" \
          --arg scan_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --arg repository "${{ github.repository }}" \
          --arg run_id "${{ github.run_id }}" \
          --argjson zap_data "$(cat report_json.json)" \
          '{
            source: $source,
            scan_date: $scan_date,
            repository: $repository,
            run_id: $run_id,
            payload: $zap_data
          }')

        # Calcular firma HMAC (usando el mismo WEBHOOK_SECRET que tienes en Vercel)
        SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "19f007ae970455d603a8734ec572d19a4b013169" | sed 's/^.* //')

        # Enviar al webhook de Vercel
        curl -X POST "https://parser-dependabot.vercel.app/webhook" \
          -H "Content-Type: application/json" \
          -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
          -d "$PAYLOAD" \
          --fail-with-body \
          -v
      continue-on-error: true
